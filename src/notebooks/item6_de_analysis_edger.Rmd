# Item 6 - DEG per cohort

EdgeR use um FDR cutoff que dê entre 100 a 1000 DEGs.

-   Adult1_Positive_Male_D2v0 (pareado)
-   Adult2_Positive_Male_D2v0 (pareado)
-   Adult3_Positive_Male_D2v0 (pareado)
-   Elderly1_Positive_Male_D2v0 (pareado) ...repetir para TODOS que tem pelo menos 2 amostras.

### Settings

```{r "setup", include=FALSE}
rm(list = ls())

basedir <- '~/Documents/work/Sex-differences-of-Pneumoccocal-colonization/'
outdir = file.path(basedir,'intermediate/item6_DEtables/')
if(!dir.exists(outdir)) dir.create(outdir)
knitr::opts_knit$set(root.dir = basedir)

pkgs <- c('tidyverse','data.table','ggplot2','edgeR')
suppressPackageStartupMessages(sapply(pkgs, require, character.only = T))

studies = c('MUCOSAL','LAIV1','LAIV2','AGES')
```

### Load Data

```{r}
fnames <- list.files('data/tidy_data/Rdata/', full.names = T)
studies <- lapply(fnames, readRDS) %>% setNames(basename(gsub('\\.rds','',fnames)))
```

### Functions

```{r}
run_edgeR <- function(counts, pheno) {
  de <- DGEList(counts = counts, samples = pheno)

  design <- model.matrix(~ volunteer_id + timepoint,data = pheno)
  
  keep <- filterByExpr(de, design)
  de <- de[keep, , keep.lib.sizes=FALSE]
  
  de <- calcNormFactors(de)
  de <- estimateDisp(de, design)
  
  fit <- glmQLFit(de, design)
  qlf <- glmQLFTest(fit, coef = grep('timepoint',colnames(design), value = T))
  return(qlf)
}
```

## Run edgeR to all groups and studies

groups to skip:

-   Adult1_POS_M (n = 1)

-   Adults2_POS_M (n = 2)

```{r}
comparisons <- lapply(studies, function(df) df$pheno) %>% Reduce(rbind,.) %>%
  group_by(class) %>% summarise(num_samples = n()) %>% 
  mutate(dataset = gsub('_.*','',class)) %>% 
  relocate(dataset) %>% 
  filter(num_samples > 2)
```

```{r}
edger.res <- apply(comparisons, 1, function(df){
  dataset.name = df[1]
  comp.name = df[2]
  
  pheno.sub <- studies[[dataset.name]]$pheno[which(studies[[dataset.name]]$pheno$class == comp.name),]
  counts.sub = studies[[dataset.name]]$counts[,pheno.sub$sample_id]
  
  message(dataset.name,'\t-\t',comp.name,'\t-\t',df[3],'\t-\t',
          ncol(counts.sub),'\t-\t',nrow(pheno.sub),'\t-\t',
          identical(pheno.sub$sample_id,colnames(counts.sub)))
  
  list(run_edgeR(counts = counts.sub, pheno = pheno.sub)) %>% setNames(comp.name)
}) %>% unlist(recursive = F)
```

Extract topTags from edgeR result objects

```{r}
top.tables <- lapply(names(edger.res), function(group_name) edger.res[[group_name]] %>% 
                       topTags(n = Inf) %>% as.data.frame %>% 
                       rownames_to_column('gene_id') %>%
                       mutate(group_name = group_name)) %>% setNames(names(edger.res))
top.tables
# head()
```

Save topTags

```{r}
lapply(names(top.tables), function(group_name) top.tables[[group_name]] %>% 
         fwrite(file.path(outdir,paste0('edgeR_topTable_',group_name,'.csv')), sep = '\t',quote = F, row.names = F))
```
