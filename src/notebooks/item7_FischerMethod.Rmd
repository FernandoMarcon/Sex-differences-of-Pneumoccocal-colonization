# Calculate meta-DEGs using Fischer method

```{r "setup", include=FALSE}
rm(list = ls())

basedir <- '~/Documents/work/Sex-differences-of-Pneumoccocal-colonization/'
outdir = file.path(basedir,"intermediate/item7_metaDEGs_FischerMethod/")
knitr::opts_knit$set(root.dir = basedir)

pkgs <- c('tidyverse','data.table','ggplot2','metap')
suppressPackageStartupMessages(sapply(pkgs, require, character.only = T))


studies = c('MUCOSAL','LAIV1','LAIV2','AGES')
pval_thrs <- 0.01
```

Input

```{r}
fnames <- list.files('intermediate/item6_DEtables/', full.names = T, pattern = 'detable_edger')
de.tables <- lapply(fnames, fread, data.table = F) %>% Reduce(rbind, .)
head(de.tables)
```

Filter Genes

$|log(FC)| > 0, p-value < 0.01$

```{r}
df <- de.tables %>% select(gene_id, group_name, PValue) %>% 
  # filter(PValue < 0.01) %>% 
  distinct() %>%
  spread(key = group_name, value = PValue) %>% 
  column_to_rownames('gene_id')
  
```

Including Elderly dataset

```{r}
Pcombined <- unlist(lapply(rownames(df), function(x) { sumlog(as.numeric(df[x,])[!is.na(as.numeric(df[x,]))])$p } ))

df$FisherMethodP <- Pcombined

df$FDR <- p.adjust(Pcombined, method = "fdr", n = length(Pcombined[!is.na(Pcombined)]))
table(df$FDR < 0.01)
table(df$FisherMethodP < 0.01)

temp = df %>% rownames_to_column('gene_id')
fwrite(temp, file.path(outdir, "FisherMethodPCombined_wElderly.csv"), sep = '\t', row.names = F, quote = F)
head(temp)
```

Without Elderly dataset

```{r}
df = df[,-grep("Elderly",colnames(df))]
Pcombined <- unlist(lapply(rownames(df), function(x) { sumlog(as.numeric(df[x,])[!is.na(as.numeric(df[x,]))])$p } ))

df$FisherMethodP <- Pcombined

df$FDR <- p.adjust(Pcombined, method = "fdr", n = length(Pcombined[!is.na(Pcombined)]))
table(df$FDR < 0.01)
table(df$FisherMethodP < 0.01)

temp = df %>% rownames_to_column('gene_id')
fwrite(temp, file.path(outdir, "FisherMethodPCombined_Adults.csv"), sep = '\t', row.names = F, quote = F)
head(temp)


```
